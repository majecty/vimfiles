#!/usr/bin/env ruby

require 'fileutils'
require 'open-uri'
require 'tempfile'
require 'zlib'
require 'rubygems'
require 'yaml'
require 'zip/zipfilesystem'
require 'archive/tar/minitar'

include Archive::Tar

def do_open(url)
    retries = 10
    
    begin
      return open(url).read

    rescue Timeout::Error
        retries -= 1
        if retries > 0
            sleep 0.42 and retry
        else
            raise
        end
    end
end

w_dir = File.expand_path(File.dirname(__FILE__))
bundles_dir = File.join(w_dir, '../bundle')
config = YAML.load(File.open(File.join(w_dir, '../config/plugins.yml')))

pathogen_f_path = File.join(w_dir, '../autoload/pathogen.vim')
unless File.exist?(pathogen_f_path)
  FileUtils.mkdir_p(File.dirname(pathogen_f_path))
  File.open(pathogen_f_path, 'w') {|f| f << do_open('http://github.com/tpope/vim-pathogen/raw/master/autoload/pathogen.vim')}
end

FileUtils.mkdir_p(bundles_dir) unless File.exist?(bundles_dir)
FileUtils.cd(bundles_dir)
Dir['*'].each {|d| FileUtils.rm_rf d}

config.each do |plugin|
  name, dir = plugin['names'].first, plugin['dir']
  if plugin.has_key?('repo') && plugin['repo'] =~ /^git:\/\/.*\.git$/
    puts "  Unpacking #{name} into #{dir}"
    `git clone -q #{plugin['repo']} #{dir}`
    FileUtils.rm_rf(File.join(dir, '.git'))
  elsif plugin.has_key?('bzrrepo')
    puts "  Unpacking #{name} into #{dir}"
    `bzr get -q #{plugin['bzrrepo']} #{dir}`
    FileUtils.rm_rf(File.join(dir, '.bzr'))
  elsif plugin.has_key?('svnrepo')
    puts "  Unpacking #{name} into #{dir}"
    `svn checkout -q #{plugin['svnrepo']} #{dir}`
    FileUtils.rm_rf(File.join(dir, '.svn'))
  elsif plugin.has_key?('vim_org_id')
    puts '  Downloading ' + name
    url = "http://www.vim.org/scripts/download_script.php?src_id=#{plugin['vim_org_id']}"
    case plugin['file_type']
    when 'vim'
      f_path = File.join(dir, plugin['plugin_type'], dir + '.vim')
      FileUtils.mkdir_p(File.dirname(f_path))
      File.open(f_path, 'w') {|f| f << do_open(url)}
    when 'tar.gz', 'tgz'
      Minitar.unpack(Zlib::GzipReader.new(open(url)), dir)
    when 'zip'
      temp_f = Tempfile.new('vim_plugin')
      temp_f << do_open(url)
      temp_f.flush
      Zip::ZipFile.open(temp_f.path) do |zip_f|
        zip_f.each do |entry|
          f_path = File.join(dir, entry.name)
          FileUtils.mkdir_p(File.dirname(f_path)) unless File.exist?(File.dirname(f_path))
          zip_f.extract(entry, f_path)
        end
      end
    when 'vba'
      temp_f = Tempfile.new('vim_plugin')
      temp_f << do_open(url)
      temp_f.flush
      dir = File.expand_path(dir)
      vba = File.expand_path(File.join(bundles_dir, 'vimball'))
      FileUtils.mkdir_p(dir)
      `vim -nes -N +'set rtp=#{dir},#{vba}' +'set ft=vim' +'so %' +'q!' #{temp_f.path}`
    when 'vba.gz'
      temp_gz_f = Tempfile.new('vim_plugin')
      temp_gz_f << do_open(url)
      temp_gz_f.flush

      temp_f = Tempfile.new('vim_plugin')
      `gunzip -c #{temp_gz_f.path} > #{temp_f.path}`

      dir = File.expand_path(dir)
      vba = File.expand_path(File.join(bundles_dir, 'vimball'))
      FileUtils.mkdir_p(dir)
      `vim -nes -N +'set rtp=#{dir},#{vba}' +'set ft=vim' +'so %' +'q!' #{temp_f.path}`
    else
      raise '  Bad file_type: ' + plugin['file_type']
    end
  else
    raise '  Bad config (missing both vim_org_id and repo keys)'
  end
end
